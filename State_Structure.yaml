# TP_NFC Application State Structure
# AI Reference for understanding threading and synchronization patterns

application_modes:
  reception_station:
    registration_mode:
      states:
        - idle: "Waiting for Guest ID input"
        - background_scanning: "Continuous tag detection for info display"  
        - writing_tag: "10s operation, blocks all transitions"
      transitions:
        - to_checkpoint_mode: "Switch to Check-in Mode button"
        - to_settings: "Settings button (blocked during write operation)"
        - to_other_stations: "Station buttons (blocked during write operation)"
      
    checkpoint_mode:
      states:
        - scanning: "Continuous background scanning for check-ins"
        - processing: "Processing detected tag check-in"
      transitions:
        - to_registration_mode: "Switch to Registration Mode button"
        - to_settings: "Settings button (allowed)"
        - to_other_stations: "Station buttons (allowed)"

  other_stations:
    checkpoint_only:
      states:
        - scanning: "Continuous background scanning for check-ins"
        - processing: "Processing detected tag check-in"
      transitions:
        - to_reception: "Reception button"
        - to_settings: "Settings button (allowed)"
        - between_stations: "Other station buttons (allowed)"

overlay_modes:
  settings_panel:
    states:
      - menu_idle: "Settings menu displayed"
      - tag_info_operation: "10s tag read for info display"
      - erase_operation: "10s tag read for erase confirmation"
    transitions:
      - to_rewrite_mode: "Rewrite Tag button"
      - return_to_previous: "Close settings - returns to exact previous state"
    restrictions:
      - blocks_station_changes: "During active operations only"
      
  rewrite_mode:
    states:
      - idle: "Waiting for Guest ID entry"
      - background_scanning: "Helpful tag detection with status messages"
      - checking_registration: "5s operation to verify tag status"
      - confirmation_dialog: "User confirmation for overwrite"
      - writing: "Actual tag write operation"
    transitions:
      - exit_to_reception: "X button returns to Reception registration"
    restrictions:
      - blocks_all_transitions: "Complete isolation during operations"
      - stops_all_background_scanning: "Prevents conflicts"

  tag_info_display:
    states:
      - displaying_info: "Guest information shown"
      - auto_close_countdown: "10s countdown to auto-close"
    transitions:
      - return_to_origin: "Returns to exact state that triggered tag info"
    special_behavior:
      - allows_background_scanning: "Only in checkpoint modes"

threading_patterns:
  scanning_control:
    flags:
      - is_scanning: "Master control for background scanning loops"
      - _scanning_thread_active: "Prevents concurrent NFC read threads"
    
  operation_coordination:  
    flags:
      - operation_in_progress: "Blocks new user-initiated operations"
      - _active_operations: "Counter for background tasks"
    operation_specific_flags:
      - _write_operation_active: "Registration tag writing"
      - _rewrite_operation_active: "Rewrite mode operations"  
      - _rewrite_check_operation_active: "Rewrite pre-check phase"
      - _tag_info_operation_active: "Tag info reading"
      - _erase_operation_active: "Tag erase operations"

  ui_thread_safety:
    patterns:
      - main_thread_scheduling: "self.after() for all UI updates from threads"
      - safe_widget_access: "_safe_configure_*() methods with existence checks"
      - widget_cleanup: "Proper destruction order and reference clearing"

critical_synchronization_points:
  potential_race_conditions:
    - station_switching_during_operations: "Must complete or cancel active operations"
    - settings_access_during_scanning: "Background scanning continues in checkpoint modes"
    - rapid_button_clicks: "Operation flags prevent duplicate operations"
    - widget_updates_after_destruction: "Safe update patterns prevent crashes"
    
  confirmed_race_condition_vulnerabilities:
    - reception_checkpoint_processing: "ISSUE: Tag processing allows transitions mid-operation, no operation_in_progress blocking"
    - other_stations_processing: "ISSUE: Same as reception - check-in processing doesn't block transitions"
    - concurrent_nfc_operations: "ISSUE: Tag Info/Erase can run while background checkpoint scanning active"
    - rewrite_background_vs_button: "ISSUE: Background rewrite scanning + user button operation potential conflict"
    - tag_info_dual_scanning: "ISSUE: Tag Info allows checkpoint scanning = two NFC operations simultaneously"
    - manual_checkin_concurrency: "ISSUE: Quick guest list check-in doesn't set operation_in_progress"
    - state_restoration_corruption: "ISSUE: Rapid Settings→Station→Settings could corrupt _came_from_settings flag"
    
  edge_cases_to_test:
    - reception_mode_rapid_toggle: "Registration <-> Checkpoint switching"
    - settings_during_background_scan: "Overlay without stopping background"
    - network_failure_during_operations: "Graceful degradation required"
    - nfc_reader_disconnect: "Connection loss during active operations"
    - rapid_transitions: "Settings → Station → Settings → Rewrite chains"
    - dual_nfc_reader_conflict: "Multiple scanning operations to same hardware"

state_restoration_logic:
  settings_panel:
    mechanism: "Remember previous station and mode for return"
    variables: "_came_from_settings flag tracking"
    
  tag_info_display:
    mechanism: "Return to triggering state after display/timeout"
    special_case: "Resume checkpoint scanning if came from checkpoint mode"
    
  rewrite_mode:
    mechanism: "Always returns to Reception registration mode"
    cleanup: "Cancel all rewrite-specific operations and flags"

nfc_timing_constraints:
  do_not_modify:
    - scanning_loop_delays: "3-5 second timeouts for responsiveness"
    - operation_timeouts: "10s for user operations, 5s for checks"
    - restart_delays: "100ms-2000ms for error recovery"
  
  rationale:
    - ui_responsiveness: "Short timeouts allow quick mode switches"
    - cancellation_support: "Easy to stop scanning when switching"
    - error_recovery: "Quick restart if NFC reader hangs"