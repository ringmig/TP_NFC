name: Build Android APK
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git unzip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
        
    - name: Install buildozer dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer cython
        
    - name: Accept Android licenses (pre-setup)
      run: |
        mkdir -p "$HOME/.android"
        echo '24333f8a63b6825ea9c5514f83c2829b004d1fee' > "$HOME/.android/repositories.cfg"
        
        # Pre-accept all known Android licenses
        mkdir -p "$HOME/.android/licenses"
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > "$HOME/.android/licenses/android-sdk-license"
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$HOME/.android/licenses/android-sdk-license"
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> "$HOME/.android/licenses/android-sdk-license"
        
    - name: Build APK  
      working-directory: Android
      run: |
        # Start buildozer to let it download SDK first
        echo "Starting buildozer to setup SDK..."
        timeout 300 buildozer android debug || echo "Initial build started SDK setup"
        
        # Now accept licenses for buildozer's SDK location
        if [ -d .buildozer/android/platform/android-sdk ]; then
          echo "Accepting licenses for project buildozer SDK..."
          mkdir -p .buildozer/android/platform/android-sdk/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > .buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> .buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> .buildozer/android/platform/android-sdk/licenses/android-sdk-license
          
          # Try to install the correct build tools
          if [ -f .buildozer/android/platform/android-sdk/tools/bin/sdkmanager ]; then
            .buildozer/android/platform/android-sdk/tools/bin/sdkmanager --sdk_root=.buildozer/android/platform/android-sdk "build-tools;28.0.3" || echo "SDK manager method 1 failed"
          fi
          
          if [ -f .buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager ]; then
            .buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=.buildozer/android/platform/android-sdk "build-tools;28.0.3" || echo "SDK manager method 2 failed"
          fi
        fi
        
        # Continue with the build
        echo "Continuing buildozer build..."
        buildozer android debug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: android-apk
        path: Android/bin/*.apk