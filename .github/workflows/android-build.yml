name: Build Android APK (Docker)
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Docker and pull buildozer images
      run: |
        echo "Setting up Docker and pulling buildozer images..."
        
        # Update Docker to latest version to handle newer image formats
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # Add current user to docker group (though may not take effect immediately)
        sudo usermod -aG docker $USER || true
        
        # Try to pull working buildozer images
        DOCKER_IMAGES=(
          "kivy/buildozer:1.5.0"
          "kivy/buildozer:1.4.0"
        )
        
        for IMAGE in "${DOCKER_IMAGES[@]}"; do
          echo "Attempting to pull $IMAGE..."
          if docker pull "$IMAGE" 2>/dev/null; then
            echo "✅ Successfully pulled $IMAGE"
            docker images | grep buildozer
            break
          else
            echo "❌ Failed to pull $IMAGE"
          fi
        done
        
        echo "Available Docker images:"
        docker images
    
    - name: Prepare buildozer.spec for Docker build
      working-directory: Android
      run: |
        echo "Preparing buildozer.spec for Docker environment..."
        
        # Ensure correct settings for Docker buildozer
        sed -i 's/^android\.api = .*/android.api = 30/' buildozer.spec
        sed -i 's/^android\.ndk = .*/android.ndk = 25b/' buildozer.spec  
        sed -i 's/^android\.minapi = .*/android.minapi = 21/' buildozer.spec
        sed -i 's/^android\.sdk = .*/android.sdk = 30/' buildozer.spec
        sed -i 's/^android\.build_tools = .*/android.build_tools = 30.0.3/' buildozer.spec
        sed -i 's/^android\.archs = .*/android.archs = armeabi-v7a/' buildozer.spec
        
        # Use stable Kivy version
        sed -i 's/^requirements = .*/requirements = python3,kivy==2.1.0/' buildozer.spec
        
        # Enable AndroidX for modern Android builds
        if ! grep -q "android.enable_androidx" buildozer.spec; then
          echo "android.enable_androidx = True" >> buildozer.spec
        else
          sed -i 's/^android\.enable_androidx = .*/android.enable_androidx = True/' buildozer.spec
        fi
        
        echo "Final buildozer.spec configuration:"
        grep -E "android\.(api|sdk|ndk|minapi|archs|build_tools|enable_androidx)|requirements" buildozer.spec
    
    - name: Build APK using Docker
      working-directory: Android
      run: |
        echo "Building APK using buildozer Docker image..."
        echo "Current directory contents:"
        ls -la
        
        # Create output directory
        mkdir -p bin
        
        # Try multiple Docker images in order of preference
        DOCKER_IMAGES=(
          "kivy/buildozer:1.5.0"
          "kivy/buildozer:1.4.0" 
          "ghcr.io/kivy/buildozer:latest"
          "registry.gitlab.com/kivy/buildozer:latest"
        )
        
        BUILD_SUCCESS=false
        
        for IMAGE in "${DOCKER_IMAGES[@]}"; do
          echo "Trying Docker image: $IMAGE"
          
          if docker run --rm \
            -v "$PWD":/home/user/hostcwd \
            -v buildozer-cache:/home/user/.buildozer \
            --workdir /home/user/hostcwd \
            "$IMAGE" \
            android debug; then
            
            echo "✅ Build succeeded with image: $IMAGE"
            BUILD_SUCCESS=true
            break
          else
            echo "❌ Build failed with image: $IMAGE, trying next..."
            # Clean up any partial builds
            rm -rf .buildozer/android/platform/build-* || true
          fi
        done
        
        if [ "$BUILD_SUCCESS" != "true" ]; then
          echo "❌ All Docker images failed. Falling back to manual buildozer installation..."
          
          # Install buildozer manually as fallback
          sudo apt-get update
          sudo apt-get install -y python3-pip openjdk-11-jdk unzip
          pip3 install buildozer==1.5.0 cython==0.29.33
          
          # Set JAVA_HOME
          export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
          
          # Try building with installed buildozer
          buildozer android debug || {
            echo "❌ Fallback buildozer also failed"
            exit 1
          }
        fi
          
        echo "Docker build completed. Searching for APK..."
        
        # Search for APK files in multiple locations
        APK_FILE=""
        
        # Method 1: Look in current directory
        APK_FILE=$(find . -name "*.apk" -type f | head -1)
        
        # Method 2: Look in .buildozer directory
        if [ -z "$APK_FILE" ]; then
          APK_FILE=$(find .buildozer -name "*.apk" -type f 2>/dev/null | head -1)
        fi
        
        # Method 3: Look in bin directory (buildozer default output)
        if [ -z "$APK_FILE" ]; then
          APK_FILE=$(find bin -name "*.apk" -type f 2>/dev/null | head -1)
        fi
        
        if [ -n "$APK_FILE" ]; then
          echo "✅ Found APK: $APK_FILE"
          # Copy to standardized location if not already there
          if [ "$APK_FILE" != "bin/testapp-debug.apk" ]; then
            cp "$APK_FILE" bin/testapp-debug.apk
            echo "✅ Copied APK to bin/testapp-debug.apk"
          fi
          ls -la bin/
          echo "APK size: $(du -h bin/testapp-debug.apk)"
        else
          echo "❌ No APK file found after Docker build"
          echo "Docker build may have failed. Checking directory structure..."
          echo "Current directory:"
          find . -type f -name "*.apk" -o -name "*.log" | head -20
          echo "Buildozer directory:"
          find .buildozer -type f -name "*.apk" -o -name "*.log" 2>/dev/null | head -20 || echo "No .buildozer directory"
          exit 1
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: android-apk-testapp-docker
        path: Android/bin/testapp-debug.apk
        if-no-files-found: fail