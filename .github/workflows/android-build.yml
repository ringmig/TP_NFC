name: Build Android APK
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git python3-pip unzip zlib1g-dev libncurses-dev libffi-dev libssl-dev autoconf libtool libtool-bin pkg-config ccache cmake
        sudo apt-get install -y automake m4 libltdl-dev gettext
        
        # Ensure libtool macros are available
        echo "Setting up libtool environment..."
        sudo ldconfig
        
        # Verify autotools installation
        echo "Autotools versions:"
        autoconf --version | head -1
        automake --version | head -1
        libtool --version | head -1
        
        # Export paths for libtool macros
        export ACLOCAL_PATH="/usr/share/aclocal"
        echo "ACLOCAL_PATH=$ACLOCAL_PATH"
        
    - name: Install Python packages
      run: |
        pip install --upgrade pip
        pip install buildozer==1.4.0 cython==0.29.33
        
    - name: Pre-setup Android SDK for license acceptance
      working-directory: Android
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        
        # Pre-create the expected SDK structure
        echo "Pre-creating SDK directory structure..."
        mkdir -p "$ANDROID_HOME"
        
        # Download command-line tools directly if buildozer hasn't done it
        if [ ! -d "$ANDROID_HOME/cmdline-tools" ]; then
          echo "Downloading Android command-line tools..."
          cd "$ANDROID_HOME"
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-6514223_latest.zip
          unzip -q commandlinetools-linux-6514223_latest.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          cd -
        fi
        
        # Let buildozer download SDK first (it will fail on licenses)
        echo "Running buildozer to continue SDK setup..."
        set +e # Don't exit on error
        timeout 600 buildozer android debug 2>&1 | tee buildozer_output.log || echo "Buildozer SDK setup phase completed"
        set -e # Re-enable exit on error
        
        # Find where sdkmanager actually is
        echo "Looking for sdkmanager..."
        find $HOME/.buildozer -name "sdkmanager" -type f 2>/dev/null || echo "No sdkmanager found yet"
        
        # Check both possible locations
        if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          echo "Found sdkmanager at: $SDKMANAGER"
        elif [ -f "$ANDROID_HOME/tools/bin/sdkmanager" ]; then
          SDKMANAGER="$ANDROID_HOME/tools/bin/sdkmanager"
          echo "Found sdkmanager at: $SDKMANAGER"
        else
          echo "ERROR: sdkmanager not found after buildozer run"
          echo "Checking buildozer output for clues..."
          grep -i "sdkmanager\|sdk\|download" buildozer_output.log | tail -20
          exit 1
        fi
        
        # Ensure sdkmanager is in PATH for the license acceptance step
        export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/tools/bin:$PATH"
        
        # Accept all Android SDK licenses
        echo "Accepting Android SDK licenses..."
        yes | $SDKMANAGER --sdk_root="$ANDROID_HOME" --licenses || echo "License acceptance completed"
        
        # Install SDK components matching our buildozer.spec
        REQUIRED_API_LEVEL="30"
        REQUIRED_BUILD_TOOLS_VERSION="30.0.3"
        
        echo "Installing Android SDK components: API $REQUIRED_API_LEVEL, Build-tools $REQUIRED_BUILD_TOOLS_VERSION..."
        $SDKMANAGER --sdk_root="$ANDROID_HOME" \
          "platforms;android-$REQUIRED_API_LEVEL" \
          "platforms;android-21" \
          "build-tools;$REQUIRED_BUILD_TOOLS_VERSION" \
          "platform-tools" \
          "cmake;3.10.2.4988404" || echo "SDK component installation completed"
        
        # Verify installation
        echo "Verifying SDK component installation..."
        ls -la "$ANDROID_HOME/platforms/" || echo "No platforms directory"
        ls -la "$ANDROID_HOME/build-tools/" || echo "No build-tools directory"
        find "$ANDROID_HOME" -name "aidl" -type f | head -5 || echo "aidl not found"
        
    - name: Build APK with licenses pre-accepted
      working-directory: Android
      run: |
        echo "Building APK with pre-accepted licenses..."
        
        # Export environment for libtool
        export ACLOCAL_PATH="/usr/share/aclocal"
        export ACLOCAL="aclocal -I /usr/share/aclocal"
        
        # Show buildozer configuration
        echo "Buildozer configuration:"
        grep -E "android\.(api|sdk|ndk|minapi|archs|build_tools)" buildozer.spec
        
        # Clean buildozer cache to ensure new settings are used
        rm -rf .buildozer/android/platform/build-*
        rm -rf .buildozer/android/platform/dists
        
        # Clean and build
        buildozer android clean
        buildozer android debug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: android-apk
        path: Android/bin/*.apk